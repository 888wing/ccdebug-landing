class CCDebuggerAPI{constructor(e="https://api.ccdebugger.com"){this.baseUrl=e,this.apiKey=null,this.timeout=1e4,this.retryAttempts=3,this.retryDelay=1e3}setConfig(e){e.endpoint&&(this.baseUrl=e.endpoint),e.apiKey&&(this.apiKey=e.apiKey),e.timeout&&(this.timeout=e.timeout)}async analyzeError(e){const t=`${this.baseUrl}/analyze`,s={error_type:e.type||"unknown",message:e.message||"",stack_trace:e.stack||"",error_context:{url:e.url||"",source_file:e.source||"",line_number:e.line||null,column_number:e.column||null,user_agent:navigator.userAgent,timestamp:e.timestamp||(new Date).toISOString()},language:this.detectLanguage(e),framework:this.detectFramework(e),metadata:{extension_version:chrome.runtime.getManifest().version,chrome_version:this.getChromeVersion()}};try{const e=await this.makeRequest("POST",t,s);return this.processAnalysisResponse(e)}catch(t){return console.error("API analysis error:",t),this.getFallbackAnalysis(e)}}async getErrorPatterns(e){const t=`${this.baseUrl}/patterns/${e}`;try{return(await this.makeRequest("GET",t)).patterns||[]}catch(e){return console.error("Failed to fetch error patterns:",e),[]}}async submitFeedback(e,t){const s=`${this.baseUrl}/feedback`,r={analysis_id:e,helpful:t.helpful,correct:t.correct,comment:t.comment||"",timestamp:(new Date).toISOString()};try{return await this.makeRequest("POST",s,r)}catch(e){throw console.error("Failed to submit feedback:",e),e}}async makeRequest(e,t,s=null){const r={"Content-Type":"application/json","X-Extension-Version":chrome.runtime.getManifest().version,"X-Client-Type":"chrome-extension"};this.apiKey&&(r.Authorization=`Bearer ${this.apiKey}`);const n={method:e,headers:r,signal:AbortSignal.timeout(this.timeout)};let i;s&&"GET"!==e&&(n.body=JSON.stringify(s));for(let e=0;e<this.retryAttempts;e++)try{const e=await fetch(t,n);if(!e.ok)throw new APIError(`API request failed: ${e.status} ${e.statusText}`,e.status,await this.parseErrorResponse(e));return await e.json()}catch(t){if(i=t,t instanceof APIError&&t.status>=400&&t.status<500)throw t;e<this.retryAttempts-1&&await this.delay(this.retryDelay*Math.pow(2,e))}throw i}async parseErrorResponse(e){try{const t=await e.json();return t.error||t.message||"Unknown error"}catch{return e.statusText||"Unknown error"}}processAnalysisResponse(e){return{analysisId:e.analysis_id||null,errorType:e.error_type||"unknown",severity:e.severity||"medium",category:e.category||"general",explanation:e.explanation||"",suggestions:this.processSuggestions(e.suggestions||[]),relatedErrors:e.related_errors||[],documentation:e.documentation||[],confidence:e.confidence||.5,tags:e.tags||[]}}processSuggestions(e){return e.map(e=>({id:e.id||null,title:e.title||e.description||"",description:e.description||"",code:e.code_example||e.code||"",confidence:e.confidence||.5,type:e.type||"general",documentation:e.documentation_url||null,applicability:e.applicability||1}))}getFallbackAnalysis(e){const t={analysisId:null,errorType:e.type||"unknown",severity:"medium",category:"general",explanation:"Analysis unavailable. Using local patterns.",suggestions:[],confidence:.3};if(e.message){const s=e.message.toLowerCase();(s.includes("undefined")||s.includes("null"))&&t.suggestions.push({title:"Check for null/undefined values",description:"Add null checks before accessing properties",code:"if (object && object.property) { /* use property */ }",confidence:.7}),s.includes("is not a function")&&t.suggestions.push({title:"Verify function exists",description:"Check if the function is defined and imported correctly",confidence:.6}),(s.includes("network")||s.includes("fetch"))&&t.suggestions.push({title:"Check network connectivity",description:"Verify API endpoints and network status",confidence:.5})}return t}detectLanguage(e){if(e.source){const t=e.source.split(".").pop().toLowerCase(),s={js:"javascript",jsx:"javascript",ts:"typescript",tsx:"typescript",py:"python",rb:"ruby",java:"java",swift:"swift",kt:"kotlin",go:"go",rs:"rust",php:"php"};if(s[t])return s[t]}if(e.message){if(e.message.includes("SyntaxError")||e.message.includes("TypeError"))return"javascript";if(e.message.includes("NameError")||e.message.includes("IndentationError"))return"python"}if(e.stack){if(e.stack.includes(".js:")||e.stack.includes(".jsx:"))return"javascript";if(e.stack.includes(".py:"))return"python"}return"javascript"}detectFramework(e){const t={react:["React","ReactDOM","useState","useEffect","Component"],vue:["Vue","v-model","v-for","$emit","mounted"],angular:["Angular","ng-","@Component","NgModule"],svelte:["Svelte","$:","export let"],next:["Next","_app","_document","getServerSideProps"],nuxt:["Nuxt","asyncData","fetch","$nuxt"]},s=`${e.message} ${e.stack||""}`;for(const[e,r]of Object.entries(t))if(r.some(e=>s.includes(e)))return e;return null}getChromeVersion(){const e=navigator.userAgent.match(/Chrome\/(\d+\.\d+\.\d+\.\d+)/);return e?e[1]:"unknown"}delay(e){return new Promise(t=>setTimeout(t,e))}}class APIError extends Error{constructor(e,t,s){super(e),this.name="APIError",this.status=t,this.details=s}}window.CCDebuggerAPI=CCDebuggerAPI;